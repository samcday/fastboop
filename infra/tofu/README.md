# fastboop bleeding infra (Cloudflare + R2)

This OpenTofu config provisions:
- An R2 bucket for bleeding snapshots.
- A Workers script that serves `https://bleeding.fastboop.win`.
- A Workers route to map the hostname.
- A DNS A record for the hostname.

The worker behavior:
- `/` and `/latest` 302 redirect to `/commit/<sha>/`.
- `/commit/<sha>/...` serves static files from R2.
- Missing paths fall back to `/commit/<sha>/index.html` for SPA routing.
- Direct artifact paths are served from R2 with CORS + range support:
  - any `*.ero` object (for EROFS image fetches), and
  - `/live-pocket-fedora/casync/*` (manifests, indexes, chunks).
- Pocketblue GitHub Actions artifacts are proxied live with CORS + range support:
  - `/pocketblue/gha/<runid>/<artifact-name>.zip`
  - example: `/pocketblue/gha/22110319241/rootfs-qualcomm-sdm845-phosh-43.zip`

## Prereqs

- OpenTofu >= 1.6
- Cloudflare account + zone
- R2 enabled for the account

## Auth

OpenTofu uses the Cloudflare provider. Export a token with these permissions:
- Account: Workers Scripts:Edit
- Account: Workers R2 Storage:Edit
- User: API Tokens Read
- User: API Tokens Write
- Zone: Workers Routes:Edit
- Zone: DNS:Edit
- Zone: Zone:Read

If you get a permission group lookup error, list available R2 permissions with:

```bash
curl -sS \
  -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
  "https://api.cloudflare.com/client/v4/user/tokens/permission_groups" | \
  jq -r '.result[] | select(.name | test("R2")) | .name'
```

If you want a CLI-friendly token creation flow, you can do it via API using your
global API key (one-time use; store it safely):

```bash
export CF_EMAIL="you@example.com"
export CF_GLOBAL_API_KEY="your-global-api-key"

permission_groups=$(curl -sS \
  -H "X-Auth-Email: $CF_EMAIL" \
  -H "X-Auth-Key: $CF_GLOBAL_API_KEY" \
  "https://api.cloudflare.com/client/v4/user/tokens/permission_groups")

pg() {
  printf '%s' "$permission_groups" | jq -r \
    ".result[] | select(.name==\"$1\") | .id"
}

workers_scripts_edit=$(pg "Workers Scripts:Edit")
workers_routes_edit=$(pg "Workers Routes:Edit")
workers_r2_edit=$(pg "Workers R2 Storage:Edit")
dns_edit=$(pg "DNS:Edit")
zone_read=$(pg "Zone:Read")

cat > token.json <<'EOF'
{
  "name": "fastboop-bleeding-tofu",
  "policies": [
    {
      "effect": "allow",
      "resources": {
        "com.cloudflare.api.account.*": "*",
        "com.cloudflare.api.zone.*": "*"
      },
      "permission_groups": []
    }
  ]
}
EOF

token_payload=$(jq \
  --arg a "$workers_scripts_edit" \
  --arg b "$workers_routes_edit" \
  --arg c "$workers_r2_edit" \
  --arg d "$dns_edit" \
  --arg e "$zone_read" \
  '.policies[0].permission_groups = [{id:$a},{id:$b},{id:$c},{id:$d},{id:$e}]' \
  token.json)

curl -sS -X POST \
  -H "X-Auth-Email: $CF_EMAIL" \
  -H "X-Auth-Key: $CF_GLOBAL_API_KEY" \
  -H "Content-Type: application/json" \
  --data "$token_payload" \
  "https://api.cloudflare.com/client/v4/user/tokens" | jq -r '.result.value'
```

That prints the token value for use with OpenTofu. You will need `jq` installed.

The GitHub provider uses a token with `repo` scope for setting Actions secrets.
Export `GITHUB_TOKEN` (or `GITHUB_OWNER`/`GITHUB_TOKEN` environment) before
running OpenTofu.

If you want the worker to proxy `/pocketblue/gha/*`, also set
`TF_VAR_pocketblue_github_token` to a GitHub token that can read Actions
artifacts from `pocketblue/pocketblue` (for fine-grained PATs: repository
`Actions: Read`).

R2 credentials are generated by OpenTofu using a Cloudflare API token resource.
That token value (and derived secret) is stored in OpenTofu state, so treat the
state file as sensitive.

State encryption is enabled with PBKDF2 + AES-GCM and expects a passphrase via
`TF_VAR_state_passphrase`. The passphrase is also written to the GitHub Actions
secret `TF_VAR_state_passphrase` for CI use.

## Apply

```bash
cd infra/tofu
export CLOUDFLARE_API_TOKEN="<token>"
export GITHUB_TOKEN="<github-token>"
export TF_VAR_account_id="444c14b123bd021dcdf0400fbd847d63"  # optional override
export TF_VAR_state_passphrase="<long-passphrase>"
export TF_VAR_pocketblue_github_token="<optional token for /pocketblue/gha/*>"

tofu init
tofu apply
```

After the first encrypted apply, remove the `fallback` blocks in
`infra/tofu/encryption.tf` and re-apply to enforce encryption.

The zone is discovered automatically using `fastboop.win`.

## Expected R2 layout

- `latest.txt` contains the latest commit SHA.
- `commit/<sha>/...` holds the site build output.

## GitHub Actions secrets

The deploy job expects these secrets:
- `R2_ACCESS_KEY_ID`
- `R2_SECRET_ACCESS_KEY`
- `R2_BUCKET` (match the OpenTofu bucket name)
- `R2_ENDPOINT_URL` (e.g. `https://<account-id>.r2.cloudflarestorage.com`)
