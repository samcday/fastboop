name: CI

on:
  workflow_call:
  pull_request:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev libgtk-3-dev libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev librsvg2-dev libglib2.0-dev libudev-dev libxdo-dev \
            musl-tools linux-libc-dev device-tree-compiler

      - name: Set up musl kernel headers
        run: |
          # The stage0 generator cross-builds to aarch64-unknown-linux-musl.
          # bindgen (clang) needs asm/ and linux/ headers findable for that target.
          # On x86_64, asm-generic works for the ioctl.h etc. that ublk needs.
          sudo mkdir -p /usr/include/$(uname -m)-linux-musl
          sudo ln -sf /usr/include/linux /usr/include/$(uname -m)-linux-musl/linux
          sudo ln -sf /usr/include/asm-generic /usr/include/$(uname -m)-linux-musl/asm-generic
          if [ -d /usr/include/$(uname -m)-linux-gnu/asm ]; then
            sudo ln -sf /usr/include/$(uname -m)-linux-gnu/asm /usr/include/$(uname -m)-linux-musl/asm
          elif [ -d /usr/include/asm ]; then
            sudo ln -sf /usr/include/asm /usr/include/$(uname -m)-linux-musl/asm
          fi
          # Also ensure bare /usr/include/asm exists for cross-target bindgen.
          # bindgen for the aarch64 cross target may search system include paths.
          if [ ! -e /usr/include/asm ]; then
            sudo ln -sf /usr/include/asm-generic /usr/include/asm
          fi

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-unknown-linux-musl
          rustflags: "--cfg=web_sys_unstable_apis"

      - name: Install cargo-binstall
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-binstall

      - name: Install Dioxus CLI
        run: cargo binstall dioxus-cli --force --no-confirm

      - name: Format
        run: cargo fmt --all -- --check

      - name: Check
        run: cargo check --workspace --locked

      - name: Clippy
        run: cargo clippy --workspace --all-targets

      - name: Test
        run: cargo test --workspace --locked

      - name: Resolve web base path
        id: web-base
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            echo "base_path=/${{ github.event.release.tag_name }}/" >> "$GITHUB_OUTPUT"
          else
            echo "base_path=/commit/${GITHUB_SHA}/" >> "$GITHUB_OUTPUT"
          fi

      - name: Dioxus build (web release)
        run: dx build -p fastboop-web --release --base-path "${{ steps.web-base.outputs.base_path }}"

      - name: Dioxus build (desktop release)
        run: dx build -p fastboop-desktop --release

      - name: Upload bleeding snapshot to R2
        if: github.ref == 'refs/heads/main'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_REGION: auto
          AWS_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
        run: |
          set -euo pipefail
          build_dir="target/dx/fastboop-web/release/web/public"
          dest_prefix="commit/${GITHUB_SHA}"
          aws s3 sync "$build_dir" "s3://fastboop-bleeding/$dest_prefix/" --endpoint-url "$AWS_ENDPOINT_URL"
          printf '%s' "$GITHUB_SHA" > latest.txt
          aws s3 cp latest.txt "s3://fastboop-bleeding/latest.txt" --endpoint-url "$AWS_ENDPOINT_URL" --cache-control "no-store"

      - name: Package web release tarball
        if: github.event_name == 'release'
        env:
          WEB_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          if ! [[ "$WEB_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$ ]]; then
            echo "release tag must match vX.Y.Z or vX.Y.Z-rc.N" >&2
            exit 1
          fi
          build_dir="target/dx/fastboop-web/release/web/public"
          tarball="fastboop-web-${WEB_TAG}.tar.gz"
          tar -C "$build_dir" -czf "$tarball" .
          echo "WEB_TARBALL=$tarball" >> "$GITHUB_ENV"

      - name: Upload web release asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.event.release.name }}
          files: |
            ${{ env.WEB_TARBALL }}

      - name: Bump fastboop-web live version pin
        if: github.event_name == 'release'
        env:
          WEB_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          if ! [[ "$WEB_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$ ]]; then
            echo "release tag must match vX.Y.Z or vX.Y.Z-rc.N" >&2
            exit 1
          fi

          target_file="infra/k8s/fastboop-web/live-version.txt"

          for attempt in 1 2 3; do
            echo "attempt $attempt: setting $target_file -> $WEB_TAG"
            git fetch origin main
            git checkout -B main origin/main

            printf '%s\n' "$WEB_TAG" > "$target_file"
            if git diff --quiet -- "$target_file"; then
              echo "live version already set to $WEB_TAG"
              exit 0
            fi

            git add "$target_file"
            git -c user.name='github-actions[bot]' -c user.email='41898282+github-actions[bot]@users.noreply.github.com' \
              commit -m "chore(infra): set www live version to $WEB_TAG"

            if git push origin HEAD:main; then
              echo "pushed live version bump to main"
              exit 0
            fi

            echo "push failed, retrying"
            sleep "$attempt"
          done

          echo "failed to push live version bump after retries" >&2
          exit 1

  build:
    runs-on: ${{ matrix.runner }}
    needs: check

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: x86_64
            runner: ubuntu-24.04
            target: x86_64-unknown-linux-musl
          - name: aarch64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools linux-libc-dev

      - name: Set up musl kernel headers
        run: |
          # libusb1-sys vendored build needs linux headers in the musl sysroot.
          sudo mkdir -p /usr/include/$(uname -m)-linux-musl
          sudo ln -sf /usr/include/linux /usr/include/$(uname -m)-linux-musl/linux
          sudo ln -sf /usr/include/asm-generic /usr/include/$(uname -m)-linux-musl/asm-generic
          if [ -d /usr/include/$(uname -m)-linux-gnu/asm ]; then
            sudo ln -sf /usr/include/$(uname -m)-linux-gnu/asm /usr/include/$(uname -m)-linux-musl/asm
          elif [ -d /usr/include/asm ]; then
            sudo ln -sf /usr/include/asm /usr/include/$(uname -m)-linux-musl/asm
          fi
          # Also ensure bare /usr/include/asm exists for cross-target bindgen.
          # bindgen for the cross target may search system include paths.
          if [ ! -e /usr/include/asm ]; then
            sudo ln -sf /usr/include/asm-generic /usr/include/asm
          fi

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}
          rustflags: "--cfg=web_sys_unstable_apis"

      - name: Build CLI (static musl)
        run: |
          cargo build \
            -p fastboop-cli \
            --release \
            --target ${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fastboop-${{ matrix.name }}
          path: target/${{ matrix.target }}/release/fastboop-cli

  stage0-static:
    name: Stage0 static (${{ matrix.target }})
    runs-on: ubuntu-24.04
    needs: check

    strategy:
      fail-fast: false
      matrix:
        include:
          - artifact: fastboop-stage0-x86_64
            target: x86_64-unknown-linux-musl
            asset_name: fastboop-stage0-x86_64-unknown-linux-musl
          - artifact: fastboop-stage0-aarch64
            target: aarch64-unknown-linux-musl
            asset_name: fastboop-stage0-aarch64-unknown-linux-musl

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools linux-libc-dev

      - name: Set up musl kernel headers
        run: |
          sudo mkdir -p /usr/include/$(uname -m)-linux-musl
          sudo ln -sf /usr/include/linux /usr/include/$(uname -m)-linux-musl/linux
          sudo ln -sf /usr/include/asm-generic /usr/include/$(uname -m)-linux-musl/asm-generic
          if [ -d /usr/include/$(uname -m)-linux-gnu/asm ]; then
            sudo ln -sf /usr/include/$(uname -m)-linux-gnu/asm /usr/include/$(uname -m)-linux-musl/asm
          elif [ -d /usr/include/asm ]; then
            sudo ln -sf /usr/include/asm /usr/include/$(uname -m)-linux-musl/asm
          fi
          if [ ! -e /usr/include/asm ]; then
            sudo ln -sf /usr/include/asm-generic /usr/include/asm
          fi
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}

      - name: Preflight stage0 target support
        run: |
          set -euo pipefail
          rustc --print target-list | grep -Fx "${{ matrix.target }}" >/dev/null

      - name: Build stage0 (static musl)
        run: |
          set -euo pipefail
          target_env="$(echo "${{ matrix.target }}" | tr '-' '_' | tr '[:lower:]' '[:upper:]')"
          linker_var="CARGO_TARGET_${target_env}_LINKER"
          rustflags_var="CARGO_TARGET_${target_env}_RUSTFLAGS"

          export "${linker_var}=rust-lld"
          export "${rustflags_var}=-C target-feature=+crt-static"

          cargo build \
            -p fastboop-stage0 \
            --release \
            --target "${{ matrix.target }}" \
            --locked

      - name: Verify stage0 binary is static
        run: |
          set -euo pipefail
          bin="target/${{ matrix.target }}/release/fastboop-stage0"
          file "$bin"
          file "$bin" | grep -Eq 'statically linked|static-pie linked'

      - name: Stage stage0 release asset
        run: |
          set -euo pipefail
          mkdir -p stage0-assets
          cp "target/${{ matrix.target }}/release/fastboop-stage0" "stage0-assets/${{ matrix.asset_name }}"

      - name: Upload stage0 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: stage0-assets/${{ matrix.asset_name }}
