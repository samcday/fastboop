name: alpine

on:
  workflow_call:
    inputs:
      release_mode:
        description: Release mode from orchestrator
        required: false
        type: string
        default: none
  workflow_dispatch:

permissions:
  contents: write

jobs:
  alpine:
    runs-on: ubuntu-24.04${{ matrix.arch == 'aarch64' && '-arm' || '' }}
    strategy:
      matrix:
        arch:
          - x86_64
          - aarch64
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - uses: samcday/setup-alpine@main
        id: alpine
        with:
          arch: ${{ matrix.arch }}
          branch: edge
          packages: alpine-sdk

      - uses: actions/download-artifact@v4
        if: inputs.release_mode == 'pr' || inputs.release_mode == 'tag'
        with:
          name: fastboop-stage0-aarch64
          path: ${{ steps.alpine.outputs.root-path }}/tmp/stage0-artifacts

      - name: configure abuild key + deps
        run: |
          abuild-keygen -a -n
          cp ~/.abuild/*.pub /etc/apk/keys/
          abuild -F deps
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            apk add --no-cache curl
            export RUSTUP_INIT_SKIP_PATH_CHECK=yes
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
              | sh -s -- -y --no-modify-path --profile minimal --default-toolchain 1.88.0
            export PATH="$HOME/.cargo/bin:$PATH"
            rustup target add aarch64-unknown-linux-musl
          fi
        shell: alpine.sh --root {0}

      - name: set git revision for prerelease builds
        if: github.event_name != 'workflow_call' || inputs.release_mode != 'tag'
        run: |
          sed -i -e "s/^_gitrev=main$/_gitrev=$GITHUB_SHA/" APKBUILD
        shell: alpine.sh --root {0}

      - name: release prep
        if: inputs.release_mode == 'tag'
        run: |
          sed -i -e 's/^\(pkgver=.*\)_git$/\1/' APKBUILD
          sed -i -e '/^_gitrev=/d' -e 's/_gitrev/pkgver/g' APKBUILD
        shell: alpine.sh --root {0}

      - name: build package
        run: |
          if [ -n "${{ inputs.release_mode }}" ] && [ "${{ inputs.release_mode }}" != "none" ]; then
            export FASTBOOP_STAGE0_EMBED_PATH=/tmp/stage0-artifacts/fastboop-stage0-aarch64-unknown-linux-musl
            test -f "$FASTBOOP_STAGE0_EMBED_PATH"
            sed -i -e 's/^options="net"$/options="net !check"/' APKBUILD
          else
            if [ "${{ matrix.arch }}" = "x86_64" ]; then
              export FASTBOOP_STAGE0_TARGET=aarch64-unknown-linux-musl
              export FASTBOOP_STAGE0_CARGO="$HOME/.cargo/bin/cargo"
            else
              export FASTBOOP_STAGE0_TARGET=aarch64-alpine-linux-musl
            fi
          fi
          export PACKAGER_PRIVKEY=$HOME/.abuild/key.rsa
          abuild -F checksum
          abuild -F -P /packages
          mv APKBUILD /packages
          chmod -R 777 /packages
          for f in /packages/fastboop/${{ matrix.arch }}/*.apk; do
            mv "$f" "${f%.apk}-${{ matrix.arch }}.apk"
          done
        shell: alpine.sh --root {0}

      - uses: actions/upload-artifact@v4
        if: matrix.arch == 'x86_64'
        with:
          name: APKBUILD
          path: ${{ steps.alpine.outputs.root-path }}/packages/APKBUILD

      - uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: ${{ steps.alpine.outputs.root-path }}/packages/fastboop/${{ matrix.arch }}/*.apk
