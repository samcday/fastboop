name: Release

on:
  push:
    tags:
      - "v*"
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: read

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.detect.outputs.enabled }}
      mode: ${{ steps.detect.outputs.mode }}
      prerelease: ${{ steps.detect.outputs.prerelease }}
      version: ${{ steps.detect.outputs.version }}
      tag: ${{ steps.detect.outputs.tag }}
    steps:
      - id: detect
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_TYPE: ${{ github.ref_type }}
          REF_NAME: ${{ github.ref_name }}
          REPOSITORY: ${{ github.repository }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
        run: |
          set -euo pipefail

          enabled=false
          mode=none
          prerelease=false
          version=""

          if [[ "$EVENT_NAME" == "push" ]] \
            && [[ "$REF_TYPE" == "tag" ]] \
            && [[ "$REF_NAME" =~ ^v([0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?)$ ]]; then
            enabled=true
            mode=tag
            version="${BASH_REMATCH[1]}"
          elif [[ "$EVENT_NAME" == "pull_request" ]] \
            && [[ "$PR_HEAD_REPO" == "$REPOSITORY" ]] \
            && [[ "$PR_HEAD_REF" =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?)$ ]]; then
            enabled=true
            mode=pr
            version="${BASH_REMATCH[1]}"
          fi

          if [[ -n "$version" && "$version" =~ -rc\.[0-9]+$ ]]; then
            prerelease=true
          fi

          echo "enabled=$enabled" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "prerelease=$prerelease" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=v$version" >> "$GITHUB_OUTPUT"

  release:
    needs: gate
    if: needs.gate.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - if: needs.gate.outputs.mode == 'tag'
        name: Require release automation token
        env:
          RELEASE_GITHUB_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "$RELEASE_GITHUB_TOKEN" ]]; then
            echo "RELEASE_GITHUB_TOKEN secret is required for release automation."
            exit 1
          fi

      - if: needs.gate.outputs.mode == 'tag'
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.gate.outputs.tag }}
          generate_release_notes: true
          prerelease: ${{ needs.gate.outputs.prerelease }}
          draft: true
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}

      - if: needs.gate.outputs.mode == 'pr'
        run: |
          echo "release/v* PR mode: skipping draft creation"

  ci:
    needs: [gate, release]
    if: needs.gate.outputs.enabled == 'true'
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  stage0-preflight:
    needs: [gate, release, ci]
    if: needs.gate.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: fastboop-stage0-x86_64
          path: stage0-preflight/fastboop-stage0-x86_64

      - uses: actions/download-artifact@v4
        with:
          name: fastboop-stage0-aarch64
          path: stage0-preflight/fastboop-stage0-aarch64

      - name: Verify stage0 artifact contract
        run: |
          set -euo pipefail

          x86_64_bin="stage0-preflight/fastboop-stage0-x86_64/fastboop-stage0-x86_64-unknown-linux-musl"
          aarch64_bin="stage0-preflight/fastboop-stage0-aarch64/fastboop-stage0-aarch64-unknown-linux-musl"

          test -s "$x86_64_bin"
          test -s "$aarch64_bin"

          file "$x86_64_bin" | grep -Eq 'statically linked|static-pie linked'
          file "$aarch64_bin" | grep -Eq 'statically linked|static-pie linked'

  debian:
    needs: [gate, release, stage0-preflight]
    if: needs.gate.outputs.enabled == 'true'
    uses: ./.github/workflows/debian.yml
    with:
      release_mode: ${{ needs.gate.outputs.mode }}
    secrets: inherit

  alpine:
    needs: [gate, release, stage0-preflight]
    if: needs.gate.outputs.enabled == 'true'
    uses: ./.github/workflows/alpine.yml
    with:
      release_mode: ${{ needs.gate.outputs.mode }}
    secrets: inherit

  publish-assets:
    needs: [gate, release, ci, stage0-preflight, debian, alpine]
    if: needs.gate.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: fastboop-x86_64
          path: release-artifacts/fastboop-x86_64

      - uses: actions/download-artifact@v4
        with:
          name: fastboop-aarch64
          path: release-artifacts/fastboop-aarch64

      - uses: actions/download-artifact@v4
        with:
          name: fastboop-stage0-x86_64
          path: release-artifacts/fastboop-stage0-x86_64

      - uses: actions/download-artifact@v4
        with:
          name: fastboop-stage0-aarch64
          path: release-artifacts/fastboop-stage0-aarch64

      - uses: actions/download-artifact@v4
        with:
          name: fastboop-stage0-armv7
          path: release-artifacts/fastboop-stage0-armv7

      - uses: actions/download-artifact@v4
        with:
          name: debs-amd64
          path: release-artifacts/debs-amd64

      - uses: actions/download-artifact@v4
        with:
          name: debs-arm64
          path: release-artifacts/debs-arm64

      - uses: actions/download-artifact@v4
        with:
          name: APKBUILD
          path: release-artifacts/APKBUILD

      - uses: actions/download-artifact@v4
        with:
          name: packages-x86_64
          path: release-artifacts/packages-x86_64

      - uses: actions/download-artifact@v4
        with:
          name: packages-aarch64
          path: release-artifacts/packages-aarch64

      - name: Prepare release assets
        run: |
          set -euo pipefail
          mkdir -p release-assets

          tar -C release-artifacts/fastboop-x86_64 -czf release-assets/fastboop-cli-x86_64-unknown-linux-musl.tar.gz fastboop-cli
          tar -C release-artifacts/fastboop-aarch64 -czf release-assets/fastboop-cli-aarch64-unknown-linux-musl.tar.gz fastboop-cli

          cp release-artifacts/fastboop-stage0-x86_64/fastboop-stage0-x86_64-unknown-linux-musl release-assets/
          cp release-artifacts/fastboop-stage0-aarch64/fastboop-stage0-aarch64-unknown-linux-musl release-assets/
          cp release-artifacts/fastboop-stage0-armv7/fastboop-stage0-armv7-unknown-linux-musleabihf release-assets/

          cp release-artifacts/debs-amd64/*.deb release-assets/
          cp release-artifacts/debs-arm64/*.deb release-assets/

          cp release-artifacts/APKBUILD/APKBUILD release-assets/APKBUILD
          cp release-artifacts/packages-x86_64/*.apk release-assets/
          cp release-artifacts/packages-aarch64/*.apk release-assets/

          (
            cd release-assets
            sha256sum * > SHA256SUMS
          )

      - if: needs.gate.outputs.mode == 'pr'
        name: Verify staged release assets
        run: |
          set -euo pipefail
          test -f release-assets/fastboop-cli-x86_64-unknown-linux-musl.tar.gz
          test -f release-assets/fastboop-cli-aarch64-unknown-linux-musl.tar.gz
          test -f release-assets/fastboop-stage0-x86_64-unknown-linux-musl
          test -f release-assets/fastboop-stage0-aarch64-unknown-linux-musl
          test -f release-assets/fastboop-stage0-armv7-unknown-linux-musleabihf
          test -f release-assets/APKBUILD
          test -f release-assets/SHA256SUMS

          compgen -G 'release-assets/*.deb' >/dev/null
          compgen -G 'release-assets/*.apk' >/dev/null

      - if: needs.gate.outputs.mode == 'tag'
        name: Require release automation token
        env:
          RELEASE_GITHUB_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "$RELEASE_GITHUB_TOKEN" ]]; then
            echo "RELEASE_GITHUB_TOKEN secret is required for release asset publication."
            exit 1
          fi

      - if: needs.gate.outputs.mode == 'tag'
        name: Upload assets to draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.gate.outputs.tag }}
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}
          files: |
            release-assets/fastboop-cli-x86_64-unknown-linux-musl.tar.gz
            release-assets/fastboop-cli-aarch64-unknown-linux-musl.tar.gz
            release-assets/fastboop-stage0-x86_64-unknown-linux-musl
            release-assets/fastboop-stage0-aarch64-unknown-linux-musl
            release-assets/fastboop-stage0-armv7-unknown-linux-musleabihf
            release-assets/*.deb
            release-assets/APKBUILD
            release-assets/*.apk
            release-assets/SHA256SUMS

  pass:
    name: "âœ… Pass"
    needs: [gate, release, ci, stage0-preflight, debian, alpine, publish-assets]
    runs-on: ubuntu-latest
    if: always() && needs.gate.outputs.enabled == 'true'
    steps:
      - uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

  publish-release:
    needs: [gate, release, pass]
    if: needs.gate.outputs.mode == 'tag' && needs.pass.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Publish draft release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
          TAG_NAME: ${{ needs.gate.outputs.tag }}
        run: |
          set -euo pipefail

          if [[ -z "$GH_TOKEN" ]]; then
            echo "RELEASE_GITHUB_TOKEN secret is required to publish draft releases."
            exit 1
          fi

          gh release edit "$TAG_NAME" --repo "$GITHUB_REPOSITORY" --draft=false >/dev/null

          draft_state="$(gh api "repos/${GITHUB_REPOSITORY}/releases/tags/${TAG_NAME}" --jq '.draft')"
          if [[ "$draft_state" != "false" ]]; then
            echo "::error::release ${TAG_NAME} is still marked as draft"
            exit 1
          fi
